<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="style.css">
<title>Comisiones - Lista</title>
<style>
  body {
    font-family: Inter, system-ui, Arial;
    background: var(--bg);
    margin: 0;
    padding: 20px;
    color: #0b1823;
  }

  .wrap {
    max-width: 1100px;
    margin: auto;
    background: #fff;
    padding: 18px;
    border-radius: 10px;
    box-shadow: 0 6px 20px rgba(10,10,10,0.06);
  }

  h1 {
    color: var(--accent);
    margin: 0;
  }

  .toolbar {
    display: flex;
    gap: 10px;
    align-items: center;
    justify-content: space-between;
    margin-top: 12px;
  }

  input {
    padding: 8px;
    border-radius: 8px;
    border: 1px solid #e6eef6;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 12px;
  }

  th, td {
    padding: 8px;
    border: 1px solid #eef5fb;
    text-align: center;
    font-size: 14px;
  }

  th {
    background: var(--accent);
    color: #fff;
  }

  .pager {
    display: flex;
    gap: 8px;
    align-items: center;
    justify-content: flex-end;
  }

  button {
    padding: 8px 12px;
    border-radius: 8px;
    border: 0;
    background: var(--accent);
    color: #fff;
    cursor: pointer;
  }

  .btn-edit {
    padding: 6px 8px;
    border-radius: 6px;
    border: 0;
    cursor: pointer;
  }

  @media (max-width: 800px) {
    .toolbar {
      flex-direction: column;
      align-items: stretch;
    }
    table, thead, tbody, th, td, tr {
      display: block;
    }
    thead {
      display: none;
    }
    tr {
      margin-bottom: 12px;
    }
    td {
      border: none;
      text-align: right;
      position: relative;
      padding-left: 50%;
    }
    td::before {
      content: attr(data-label);
      position: absolute;
      left: 12px;
      width: 45%;
      text-align: left;
      font-weight: 600;
    }
  }

  .download-menu { position: relative; }

  .dropdown {
    position: relative;
    display: inline-block;
  }

  /* === Men√∫ de descarga (abre hacia la izquierda) === */
  .dropdown-content {
    display: none;
    position: absolute;
    right: 100%; /* üëà se abre hacia la izquierda */
    top: 0;
    background: #fff;
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    border-radius: 10px;
    min-width: 260px;
    padding: 8px 0;
    z-index: 9999;
    text-align: left;
  }

  /* Clase activa para mostrar men√∫ con clic */
  .dropdown-content.show {
    display: block;
  }

  /* Cada fila horizontal */
  .dropdown-content .option {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 6px 12px;
    white-space: nowrap;
    transition: background 0.2s;
  }

  .dropdown-content .option:hover {
    background: #f5f5f5;
  }

  /* √çcono de descarga */
  .download-single {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.1em;
    color: #007bff;
    padding: 3px 6px;
    line-height: 1;
    transition: transform 0.2s, color 0.2s;
    flex-shrink: 0;
  }

  .download-single:hover {
    color: #0056b3;
    transform: scale(1.15);
  }

  /* Checkbox */
  .dropdown-content input[type="checkbox"] {
    transform: scale(1.1);
    margin: 0;
    cursor: pointer;
  }

  /* Label + icono + texto */
  .dropdown-content label {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
    cursor: pointer;
    margin: 0;
    flex-grow: 1;
  }

  .dropdown-header {
  text-align: center;
  font-weight: 700;
  font-size: 16px;
  color: var(--accent);
  background: #fdf3f3;
  padding: 8px 0;
  border-bottom: 2px solid var(--accent);
  margin: -6px -10px 8px -10px; /* expande el fondo para que abarque todo el ancho del men√∫ */
  border-top-left-radius: 10px;
  border-top-right-radius: 10px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
  /* === Bot√≥n Generar ZIP === */
  .btn-combined {
    width: calc(100% - 20px);
    margin: 8px auto 6px auto;
    display: block;
    background: var(--accent);
    border: none;
    border-radius: 8px;
    padding: 8px;
    color: #fff;
    font-weight: 600;
    cursor: pointer;
    text-align: center;
    transition: background 0.25s, transform 0.2s;
  }

  .btn-combined:hover {
    background: #a40000;
    transform: scale(1.02);
  }

  /* Bot√≥n principal üì• */
  .btn-download {
    background: var(--accent);
    color: #fff;
    border: 0;
    border-radius: 6px;
    font-size: 18px;
    padding: 4px 10px;
    cursor: pointer;
  }

  /* Loader */
  #loaderOverlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.65);
    backdrop-filter: blur(3px);
    display: none;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    z-index: 99999;
    color: #fff;
    font-size: 18px;
    text-align: center;
  }

  .spinner {
    border: 6px solid rgba(255,255,255,0.2);
    border-top: 6px solid #ffffff;
    border-radius: 50%;
    width: 55px;
    height: 55px;
    animation: spin 1s linear infinite;
    margin-bottom: 10px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>
</head>
<body>

<div class="header-bar">SUBSECRETAR√çA DE EDUCACI√ìN B√ÅSICA ‚Äì MICHOAC√ÅN</div>
<div class="card">

<img src="logo.png" class="logo">

<h1>Comisiones</h1>

<div class="toolbar">
  <button onclick="location.href='index.html'">Nueva Comisi√≥n</button>
  <button id="refresh">Actualizar</button>
  <button id="salir" onclick="logout()">Salir</button>
  <input id="buscar" placeholder="Buscar...">
  <select id="filtroRein">
    <option value="all">Todos</option>
    <option value="true">‚úÖ Con reintegro</option>
    <option value="false">‚ùå Sin reintegro</option>
  </select>

  <div class="pager">
    <button id="prev">¬´Anterior</button>
    <span id="page">1</span>
    <button id="next">Siguiente¬ª</button>
  </div>
</div>

<table aria-live="polite">
<thead>
<tr>
  <th>Oficio</th>
  <th>Nombre</th>
  <th>Fechas de comisi√≥n</th>
  <th>Lugar</th>
  <th>Total Ant</th>
  <th>Total Dev</th>
  <th>Diferencia</th>
  <th>R/D</th>
  <th>Editar</th>
  <th>Descargar</th>
</tr>
</thead>

<tbody id="tbody">
  <tr><td colspan="10">Cargando...</td></tr>
</tbody>
</table>
</div>

<script>
  const session = JSON.parse(localStorage.getItem("session") || "{}");
checkSession();
function checkSession(){
  const s=JSON.parse(localStorage.getItem("session")||"{}");
  if(!s.usuario || !s.rol || Date.now()>s.exp){
    localStorage.removeItem("session");
    location.href="login.html";
  }
}

const SCRIPT_URL="https://script.google.com/macros/s/AKfycbyOB-68HNJbUPuwd1wDkPJDnrxPDAMWCsaOVFN8n6JIQWnXbqlwszOtJ3YQZIVzG3Dwvg/exec";
const SCRIPT_GEN_URL="https://script.google.com/macros/s/AKfycbwQ29HHmicmqYSs8kc7zXvHdiJtxdAPLjTOusGW-Xx-DKN_zcmJodlU-ny9t-6oahdx/exec";

let start=0, pageSize=20;

function addJSONP(q){
  const s=document.createElement("script");
  s.src=SCRIPT_URL+q;
  document.body.appendChild(s);
}

function loadPage(){
  document.getElementById("tbody").innerHTML='<tr><td colspan="10">Cargando...</td></tr>';
  addJSONP(`?historial=1&start=${start}&callback=onHist`);
}

function formatoFechaLarga(s){
  if(!s) return "";
  if(s.includes(" al ")) return s; // ya es rango
  const d=new Date(s);
  if(isNaN(d)) return s;
  return d.toLocaleDateString("es-MX",{day:"numeric",month:"long",year:"numeric"});
}

function onHist(res){
  const tbody=document.getElementById("tbody");
  tbody.innerHTML="";

  if(!res.rows || res.rows.length===0){
    tbody.innerHTML='<tr><td colspan="10">Sin registros</td></tr>';
    return;
  }

  res.rows.forEach(r=>{
    const diff=Number(r[6]||0);
    const cls=diff>0?'diff-positive':diff<0?'diff-negative':'diff-zero';
    const fechas=formatarFechas(r[2]);
    const rein=(String(r[7]).toLowerCase()==="true")?"‚úÖ":"‚ùå";

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${r[0]}</td>
      <td>${r[1]}</td>
      <td>${fechas}</td>
      <td>${r[3]}</td>
      <td>${Number(r[4]||0).toLocaleString('es-MX',{minimumFractionDigits:2})}</td>
      <td>${Number(r[5]||0).toLocaleString('es-MX',{minimumFractionDigits:2})}</td>
      <td class="${cls}">${diff.toLocaleString('es-MX',{minimumFractionDigits:2})}</td>
      <td>${rein}</td>
      <td><button onclick="goEdit('${encodeURIComponent(r[0])}')">‚úèÔ∏è</button></td>
      <td data-label="Descargar" class="download-menu">
        <div class="dropdown">
          <button title="Descargar documentos" class="btn-download">üì•</button>
          <div class="dropdown-content" data-oficio="${r[0]}" onclick="event.stopPropagation()">
            <div class="dropdown-header">
              Oficio ${r[0]}
              ${JSON.parse(localStorage.getItem("session") || "{}").rol === "admin" ? `<div class="capturador">üë§ ${r[8] || "Sin registrar"}</div>` : ""}
            </div>
            <div class="option">
              <button type="button" class="download-single" data-type="oficio">‚¨áÔ∏è</button>
              <label class="menu-option"><input type="checkbox" value="oficio"> üìÑ Oficio</label>
            </div>
            <div class="option">
              <button type="button" class="download-single" data-type="recibo">‚¨áÔ∏è</button>
              <label class="menu-option"><input type="checkbox" value="recibo"> üíµ Recibo Anticipo</label>
            </div>
            <div class="option">
              <button type="button" class="download-single" data-type="comprobacion">‚¨áÔ∏è</button>
              <label class="menu-option"><input type="checkbox" value="comprobacion"> üìë Comprobaci√≥n</label>
            </div>
            <div class="option">
              <button type="button" class="download-single" data-type="formato_unico">‚¨áÔ∏è</button>
              <label class="menu-option"><input type="checkbox" value="formato_unico"> üóÇ Formato √önico</label>
            </div>
            <div class="option">
              <button type="button" class="download-single" data-type="alimentacion">‚¨áÔ∏è</button>
              <label class="menu-option"><input type="checkbox" value="alimentacion"> üçΩ Alimentaci√≥n</label>
            </div>
            <hr style="margin:6px 0;">
            <button onclick="downloadSelected(this,'${r[0]}');return false;" class="btn-combined">üß© Generar ZIP</button>
          </div>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById("page").textContent=(start/pageSize)+1;
  // ‚úÖ Listener de descargas individuales dentro de onHist
  document.querySelectorAll(".download-single").forEach(btn => {
    btn.onclick = (evt) => {
      evt.stopPropagation();
      evt.preventDefault();

      const oficio = btn.closest(".dropdown-content")?.dataset.oficio;
      const type = btn.dataset.type;

      console.log("üéØ Click detectado:", { oficio, type });

      if (!oficio || !type) {
        alert("‚ùå No se pudo identificar el oficio o el tipo de documento.");
        return;
      }

      showLoader(true, `Generando ${type.toUpperCase()}...`);

      const cb = "cb_single_" + Date.now();
      window[cb] = (res) => {
        showLoader(false);
        console.log("üì• Respuesta del servidor:", res);

        if (!res || !res.success) {
          alert("‚ùå Error al generar el documento: " + (res?.error || "desconocido"));
          delete window[cb];
          return;
        }

        const a = document.createElement("a");
        a.href = res.url;
        a.download = "";
        document.body.appendChild(a);
        a.click();
        a.remove();
        delete window[cb];
      };

      const script = document.createElement("script");
      script.src = `${SCRIPT_GEN_URL}?oficio=${encodeURIComponent(oficio)}&type=${encodeURIComponent(type)}&callback=${cb}`;
      console.log("üì° Inyectando JSONP:", script.src);
      document.body.appendChild(script);
    };
  });
}

// ---------- UNICO LISTENER para descarga individual (funcional) ----------
document.body.addEventListener("click", (evt) => {
  const btn = evt.target.closest(".download-single");
  if (!btn) return;

  // bloqueamos la propagaci√≥n para evitar cierres prematuros
  evt.stopPropagation();
  evt.preventDefault();

  const dropdown = btn.closest(".dropdown-content");
  const oficio = dropdown?.dataset.oficio;
  const type = btn.dataset.type;

  console.log("üéØ Click en descarga individual:", { oficio, type });

  if (!oficio || !type) {
    alert("No se pudo identificar el oficio o el tipo de documento.");
    return;
  }

  showLoader(true, `Generando ${type.toUpperCase()}...`);

  const cb = "cb_single_" + Date.now();
  window[cb] = (res) => {
    showLoader(false);
    console.log("üì• Respuesta del servidor:", res);

    if (!res || !res.success) {
      alert("‚ùå Error al generar el documento: " + (res?.error || "desconocido"));
      delete window[cb];
      return;
    }

    const a = document.createElement("a");
    a.href = res.url;
    a.download = "";
    document.body.appendChild(a);
    a.click();
    a.remove();
    delete window[cb];
  };

  const script = document.createElement("script");
  script.src = `${SCRIPT_GEN_URL}?oficio=${encodeURIComponent(oficio)}&type=${encodeURIComponent(type)}&callback=${cb}`;
  console.log("üì° Inyectando JSONP:", script.src);
  document.body.appendChild(script);
});

// funci√≥n existente: formateo fechas
function formatarFechas(f){
  if(!f) return "";
  if(f.includes(" a ")||f.includes(" al ")) return f; // ya es rango
  return formatoFechaLarga(f);
}

function openMenu(btn,oficio){
  closeMenu();

  const m=document.createElement("div");
  m.className="menu-box";
  m.innerHTML=`
    <button onclick="dl('${oficio}','oficio',this)">üìÑ Oficio</button>
    <button onclick="dl('${oficio}','recibo',this)">üíµ Recibo</button>
    <button onclick="dl('${oficio}','comprobacion',this)">üìë Comprobaci√≥n</button>
    <button onclick="dl('${oficio}','formato',this)">üóÇÔ∏è Formato √önico</button>
    <button onclick="dl('${oficio}','alimentacion',this)">üçΩÔ∏è Alimentaci√≥n</button>
    <button onclick="dl('${oficio}','zip',this)">üß© ZIP (Todos)</button>
  `;
  document.body.appendChild(m);

  const r=btn.getBoundingClientRect();
  m.style.left=r.left+"px";
  m.style.top=(r.bottom+5)+"px";

  document.addEventListener("click",closeMenu,{once:true});
}

function closeMenu(){
  const old=document.querySelector(".menu-box");
  if(old) old.remove();
}

// ‚úÖ Mostrar/Ocultar loader
function showLoader(show, msg="Generando documento...") {
  const overlay = document.getElementById("loaderOverlay");
  const text = document.getElementById("loaderText");
  text.textContent = msg;
  overlay.style.display = show ? "flex" : "none";
}
function genDoc(of,type,btn){
  showLoader(true, "Generando " + type + "...");

  const cb="cb"+Date.now();
  window[cb]=resp=>{
    showLoader(false);
    if(resp.success) window.open(resp.url,"_blank");
    delete window[cb];
  };
  
  const s=document.createElement("script");
  s.src=`${SCRIPT_GEN_URL}?oficio=${encodeURIComponent(of)}&type=${encodeURIComponent(type)}&callback=${cb}`;
  document.body.appendChild(s);
}

function downloadSelected(btn, oficio){
  // obtenemos el contenedor real (que ahora tiene data-oficio)
  const dropdown = btn.closest(".dropdown-content");
  const checks = [...dropdown.querySelectorAll("input:checked")].map(i => i.value);

  console.log("downloadSelected -> oficio:", oficio, "checks:", checks);

  if(checks.length === 0){
    alert("Selecciona al menos un documento ‚úÖ");
    return;
  }

  showLoader(true, "Generando ZIP...");

  const cb = "cb_multi_" + Date.now();
  window[cb] = (res) => {
    showLoader(false);
    console.log("callback", cb, "res:", res);

    if(!res){
      alert("‚ùå Respuesta vac√≠a del servidor (ver consola).");
      delete window[cb];
      return;
    }

    if(!res.success){
      alert("‚ùå Error al generar el ZIP: " + (res.error || "desconocido"));
      console.error("server-error:", res);
      delete window[cb];
      return;
    }

    // Descargar autom√°ticamente el ZIP
    const a = document.createElement("a");
    a.href = res.url;
    a.download = ""; // nombre lo define el servidor
    document.body.appendChild(a);
    a.click();
    a.remove();

    delete window[cb];
  };

  const multiParam = encodeURIComponent(JSON.stringify(checks));
  const scriptUrl = `${SCRIPT_GEN_URL}?oficio=${encodeURIComponent(oficio)}&multi=${multiParam}&callback=${cb}`;
  console.log("Inyectando JSONP script:", scriptUrl);

  const s = document.createElement("script");
  s.src = scriptUrl;
  document.body.appendChild(s);
}

function goEdit(o){ location.href="edit.html?oficio="+encodeURIComponent(o); }

// üîπ Opcional: cuando tengamos ZIP funcionando
function genAllDocs(oficio){
  alert("ZIP de todos los documentos ‚ûú Ser√° activado en la siguiente fase ‚úÖ");
}

document.getElementById("next").onclick=()=>{start+=pageSize;loadPage();}
document.getElementById("prev").onclick=()=>{if(start>=pageSize) start-=pageSize;loadPage();}
document.getElementById("buscar").oninput=function(){
  const t=this.value.toLowerCase();
  document.querySelectorAll("#tbody tr").forEach(tr=>{
    tr.style.display=tr.innerText.toLowerCase().includes(t)?"":"none";
  });
}
document.getElementById("filtroRein").onchange=function(){
  const v=this.value;
  document.querySelectorAll("#tbody tr").forEach(tr=>{
    const est=tr.children[7]?.innerText.trim();
    tr.style.display=(v==="all")|| 
                     (v==="true" && est==="‚úÖ")||
                     (v==="false"&& est==="‚ùå")? "":"none";
  });
}

// Esperar a que el DOM est√© completamente cargado antes de registrar listeners
document.addEventListener("DOMContentLoaded", () => {
  console.log("‚úÖ DOM completamente cargado ‚Äî listener de descarga activado");

  document.body.addEventListener("click", (evt) => {
    const btn = evt.target.closest(".download-single");
    if (!btn) return;

    evt.stopPropagation();
    evt.preventDefault();

    const dropdown = btn.closest(".dropdown-content");
    const oficio = dropdown?.dataset.oficio;
    const type = btn.dataset.type;

    console.log("üéØ Click detectado en descarga individual:", { oficio, type });

    if (!oficio || !type) {
      alert("No se pudo identificar el oficio o el tipo de documento.");
      return;
    }

    showLoader(true, `Generando ${type.toUpperCase()}...`);

    const cb = "cb_single_" + Date.now();
    window[cb] = (res) => {
      showLoader(false);
      console.log("üì• Respuesta del servidor:", res);

      if (!res || !res.success) {
        alert("‚ùå Error al generar el documento: " + (res?.error || "desconocido"));
        delete window[cb];
        return;
      }

      const a = document.createElement("a");
      a.href = res.url;
      a.download = "";
      document.body.appendChild(a);
      a.click();
      a.remove();
      delete window[cb];
    };

    const script = document.createElement("script");
    script.src = `${SCRIPT_GEN_URL}?oficio=${encodeURIComponent(oficio)}&type=${encodeURIComponent(type)}&callback=${cb}`;
    console.log("üì° Inyectando JSONP:", script.src);
    document.body.appendChild(script);
  });
});

loadPage();

function logout(){
  localStorage.removeItem("session");
  location.href="login.html";
}

// Mostrar/ocultar men√∫ de descarga con clic en el bot√≥n üì•
document.addEventListener("click", (e) => {
  const button = e.target.closest(".btn-download");
  const anyMenu = document.querySelector(".dropdown-content.show");

  // Si hace clic fuera de cualquier men√∫, cerrar los que est√©n abiertos
  if (!button && anyMenu && !e.target.closest(".dropdown-content")) {
    anyMenu.classList.remove("show");
    return;
  }

  // Si hace clic en el bot√≥n üì•, alternar visibilidad del men√∫ asociado
  if (button) {
    const menu = button.parentElement.querySelector(".dropdown-content");
    if (menu) {
      const isOpen = menu.classList.contains("show");
      document.querySelectorAll(".dropdown-content.show").forEach(m => m.classList.remove("show"));
      if (!isOpen) menu.classList.add("show");
    }
  }
});

</script>
<!-- LOADER DE PANTALLA COMPLETA -->
<div id="loaderOverlay">
  <div class="spinner"></div>
  <p id="loaderText">Generando documento...</p>
</div>
</body>
</html>
