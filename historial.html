<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="style.css">
<title>Comisiones - Lista</title>
<style>

  body{font-family:Inter,system-ui,Arial;background:var(--bg);margin:0;padding:20px;color:#0b1823}
  .wrap{max-width:1100px;margin:auto;background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 20px rgba(10,10,10,0.06)}
  h1{color:var(--accent);margin:0}
  .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:12px}
  input{padding:8px;border-radius:8px;border:1px solid #e6eef6}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:8px;border:1px solid #eef5fb;text-align:center;font-size:14px}
  th{background:var(--accent);color:#fff}
  .pager{display:flex;gap:8px;align-items:center;justify-content: flex-end}
  button{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer}
  .btn-edit{padding:6px 8px;border-radius:6px;border:0;cursor:pointer}
  @media (max-width:800px){
    .toolbar{flex-direction:column;align-items:stretch}
    table,thead,tbody,th,td,tr{display:block}
    thead{display:none}
    tr{margin-bottom:12px}
    td{border:none;text-align:right;position:relative;padding-left:50%;}
    td::before{content:attr(data-label);position:absolute;left:12px;width:45%;text-align:left;font-weight:600}
  }
  .download-menu { position: relative; }

.dropdown { position: relative; display: inline-block; }

.dropdown-content {
  display: none;
  position: absolute;
  background: #fff;
  box-shadow: 0 6px 20px rgba(0,0,0,0.15);
  border-radius: 8px;
  min-width: 180px;
  z-index: 50;
  text-align: left;
}

.dropdown-content a {
  color: #0b1823;
  padding: 8px 12px;
  text-decoration: none;
  display: block;
  font-size: 14px;
}

.dropdown-content a:hover {
  background: #eef5fb;
}

.dropdown:hover .dropdown-content {
  display: block;
}

.btn-download {
  background: #8c0000;
  color: #fff;
  border: 0;
  border-radius: 6px;
  font-size: 18px;
  padding: 4px 10px;
  cursor: pointer;
}
#loaderOverlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.65);
  backdrop-filter: blur(3px);
  display: none;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  z-index: 99999;
  color: #fff;
  font-size: 18px;
  text-align: center;
}

.spinner {
  border: 6px solid rgba(255,255,255,0.2);
  border-top: 6px solid #ffffff;
  border-radius: 50%;
  width: 55px;
  height: 55px;
  animation: spin 1s linear infinite;
  margin-bottom: 10px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
/* alineaci√≥n de opci√≥n: √≠cono || checkbox + texto */
.dropdown-content .option {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 8px;
}

.dropdown-content label.menu-option {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  cursor: pointer;
  user-select: none;
}

.dropdown-content input[type="checkbox"] {
  transform: scale(1.05);
  margin: 0;
}

.download-single {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 1.05em;
  padding: 2px 6px;
  line-height: 1;
  color: #007bff;
}

.download-single:hover { color: #0056b3; }

/* ajustar ancho m√≠nimo del dropdown para que no rompa la l√≠nea */
.dropdown-content {
  min-width: 220px;
}
</style>
</head>
<body>

<div class="header-bar">SUBSECRETAR√çA DE EDUCACI√ìN B√ÅSICA ‚Äì MICHOAC√ÅN</div>
<div class="card">

<img src="logo.png" class="logo">

<h1>Comisiones</h1>

<div class="toolbar">
  <button onclick="location.href='index.html'">Nueva Comisi√≥n</button>
  <button id="refresh">Actualizar</button>
  <button id="salir" onclick="logout()">Salir</button>
  <input id="buscar" placeholder="Buscar...">
  <select id="filtroRein">
    <option value="all">Todos</option>
    <option value="true">‚úÖ Con reintegro</option>
    <option value="false">‚ùå Sin reintegro</option>
  </select>

  <div class="pager">
    <button id="prev">¬´Anterior</button>
    <span id="page">1</span>
    <button id="next">Siguiente¬ª</button>
  </div>
</div>

<table aria-live="polite">
<thead>
<tr>
  <th>Oficio</th>
  <th>Nombre</th>
  <th>Fechas de comisi√≥n</th>
  <th>Lugar</th>
  <th>Total Ant</th>
  <th>Total Dev</th>
  <th>Diferencia</th>
  <th>R/D</th>
  <th>Editar</th>
  <th>Descargar</th>
</tr>
</thead>

<tbody id="tbody">
  <tr><td colspan="10">Cargando...</td></tr>
</tbody>
</table>
</div>

<script>
checkSession();
function checkSession(){
  const s=JSON.parse(localStorage.getItem("session")||"{}");
  if(!s.usuario || !s.rol || Date.now()>s.exp){
    localStorage.removeItem("session");
    location.href="login.html";
  }
}

const SCRIPT_URL="https://script.google.com/macros/s/AKfycbyOB-68HNJbUPuwd1wDkPJDnrxPDAMWCsaOVFN8n6JIQWnXbqlwszOtJ3YQZIVzG3Dwvg/exec";
const SCRIPT_GEN_URL="https://script.google.com/macros/s/AKfycbwQ29HHmicmqYSs8kc7zXvHdiJtxdAPLjTOusGW-Xx-DKN_zcmJodlU-ny9t-6oahdx/exec";

let start=0, pageSize=20;

function addJSONP(q){
  const s=document.createElement("script");
  s.src=SCRIPT_URL+q;
  document.body.appendChild(s);
}

function loadPage(){
  document.getElementById("tbody").innerHTML='<tr><td colspan="10">Cargando...</td></tr>';
  addJSONP(`?historial=1&start=${start}&callback=onHist`);
}

function formatoFechaLarga(s){
  if(!s) return "";
  if(s.includes(" al ")) return s; // ya es rango
  const d=new Date(s);
  if(isNaN(d)) return s;
  return d.toLocaleDateString("es-MX",{day:"numeric",month:"long",year:"numeric"});
}

function onHist(res){
  const tbody=document.getElementById("tbody");
  tbody.innerHTML="";

  if(!res.rows || res.rows.length===0){
    tbody.innerHTML='<tr><td colspan="10">Sin registros</td></tr>';
    return;
  }

  res.rows.forEach(r=>{
    const diff=Number(r[6]||0);
    const cls=diff>0?'diff-positive':diff<0?'diff-negative':'diff-zero';

    const fechas=formatarFechas(r[2]);

    const rein=(String(r[7]).toLowerCase()==="true")?"‚úÖ":"‚ùå";

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${r[0]}</td>
      <td>${r[1]}</td>
      <td>${fechas}</td>
      <td>${r[3]}</td>
      <td>${Number(r[4]||0).toLocaleString('es-MX',{minimumFractionDigits:2})}</td>
      <td>${Number(r[5]||0).toLocaleString('es-MX',{minimumFractionDigits:2})}</td>
      <td class="${cls}">${diff.toLocaleString('es-MX',{minimumFractionDigits:2})}</td>
      <td>${rein}</td>
      <td><button onclick="goEdit('${encodeURIComponent(r[0])}')">‚úèÔ∏è</button></td>
      <td data-label="Descargar" class="download-menu">
        <div class="dropdown">
          <button title="Descargar documentos" class="btn-download">üì•</button>
          <!-- <-- important: data-oficio para identificar la fila -->
          <div class="dropdown-content" onclick="event.stopPropagation()" data-oficio="${r[0]}">
            <div class="option">
              <button class="download-single" data-type="oficio" title="Descargar Oficio">‚¨áÔ∏è</button>
              <label class="menu-option"><input type="checkbox" value="oficio"> üìÑ Oficio</label>
            </div>
            <div class="option">
              <button class="download-single" data-type="recibo" title="Descargar Recibo">‚¨áÔ∏è</button>
              <label class="menu-option"><input type="checkbox" value="recibo"> üíµ Recibo Anticipo</label>
            </div>
            <div class="option">
              <button class="download-single" data-type="comprobacion" title="Descargar Comprobaci√≥n">‚¨áÔ∏è</button>
              <label class="menu-option"><input type="checkbox" value="comprobacion"> üìë Comprobaci√≥n</label>
            </div>
            <div class="option">
              <button class="download-single" data-type="formato_unico" title="Descargar Formato √önico">‚¨áÔ∏è</button>
              <label class="menu-option"><input type="checkbox" value="formato_unico"> üóÇ Formato √önico</label>
            </div>
            <div class="option">
              <button class="download-single" data-type="alimentacion" title="Descargar Alimentaci√≥n">‚¨áÔ∏è</button>
              <label class="menu-option"><input type="checkbox" value="alimentacion"> üçΩ Alimentaci√≥n</label>
            </div>
            <hr style="margin:6px 0;">
            <button onclick="downloadSelected(this,'${r[0]}');return false;" class="btn-combined">üß© Generar ZIP</button>
          </div>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById("page").textContent=(start/pageSize)+1;
}

function formatarFechas(f){
  if(!f) return "";
  if(f.includes(" a ")||f.includes(" al ")) return f; // ya es rango
  return formatoFechaLarga(f);
}

function openMenu(btn,oficio){
  closeMenu();

  const m=document.createElement("div");
  m.className="menu-box";
  m.innerHTML=`
    <button onclick="dl('${oficio}','oficio',this)">üìÑ Oficio</button>
    <button onclick="dl('${oficio}','recibo',this)">üíµ Recibo</button>
    <button onclick="dl('${oficio}','comprobacion',this)">üìë Comprobaci√≥n</button>
    <button onclick="dl('${oficio}','formato',this)">üóÇÔ∏è Formato √önico</button>
    <button onclick="dl('${oficio}','alimentacion',this)">üçΩÔ∏è Alimentaci√≥n</button>
    <button onclick="dl('${oficio}','zip',this)">üß© ZIP (Todos)</button>
  `;
  document.body.appendChild(m);

  const r=btn.getBoundingClientRect();
  m.style.left=r.left+"px";
  m.style.top=(r.bottom+5)+"px";

  document.addEventListener("click",closeMenu,{once:true});
}

function closeMenu(){
  const old=document.querySelector(".menu-box");
  if(old) old.remove();
}

// ‚úÖ Mostrar/Ocultar loader
function showLoader(show, msg="Generando documento...") {
  const overlay = document.getElementById("loaderOverlay");
  const text = document.getElementById("loaderText");
  text.textContent = msg;
  overlay.style.display = show ? "flex" : "none";
}
function genDoc(of,type,btn){
  showLoader(true, "Generando " + type + "...");

  const cb="cb"+Date.now();
  window[cb]=resp=>{
    showLoader(false);
    if(resp.success) window.open(resp.url,"_blank");
    delete window[cb];
  };
  
  const s=document.createElement("script");
  s.src=`${SCRIPT_GEN_URL}?oficio=${encodeURIComponent(of)}&type=${encodeURIComponent(type)}&callback=${cb}`;
  document.body.appendChild(s);
}

function downloadSelected(btn, oficio){
  // obtenemos el contenedor real (que ahora tiene data-oficio)
  const dropdown = btn.closest(".dropdown-content");
  const checks = [...dropdown.querySelectorAll("input:checked")].map(i => i.value);

  console.log("downloadSelected -> oficio:", oficio, "checks:", checks);

  if(checks.length === 0){
    alert("Selecciona al menos un documento ‚úÖ");
    return;
  }

  showLoader(true, "Generando ZIP...");

  const cb = "cb_multi_" + Date.now();
  window[cb] = (res) => {
    showLoader(false);
    console.log("callback", cb, "res:", res);

    if(!res){
      alert("‚ùå Respuesta vac√≠a del servidor (ver consola).");
      delete window[cb];
      return;
    }

    if(!res.success){
      alert("‚ùå Error al generar el ZIP: " + (res.error || "desconocido"));
      console.error("server-error:", res);
      delete window[cb];
      return;
    }

    // Descargar autom√°ticamente el ZIP
    const a = document.createElement("a");
    a.href = res.url;
    a.download = ""; // nombre lo define el servidor
    document.body.appendChild(a);
    a.click();
    a.remove();

    delete window[cb];
  };

  const multiParam = encodeURIComponent(JSON.stringify(checks));
  const scriptUrl = `${SCRIPT_GEN_URL}?oficio=${encodeURIComponent(oficio)}&multi=${multiParam}&callback=${cb}`;
  console.log("Inyectando JSONP script:", scriptUrl);

  const s = document.createElement("script");
  s.src = scriptUrl;
  document.body.appendChild(s);
}

// üîπ Descargar documento individual desde los iconos
document.addEventListener('click', function (e) {
  const btn = e.target.closest('.download-single');
  if (!btn) return;

  const type = btn.dataset.type;
  const oficio = btn.closest('.dropdown-content')?.querySelector('.btn-combined')?.getAttribute('onclick')?.match(/'([^']+)'/)?.[1];

  if (!oficio) return alert("No se encontr√≥ el n√∫mero de oficio.");

  showLoader(true, "Generando " + type + "...");

  const cb = "cb_single_" + Date.now();
  window[cb] = (res) => {
    showLoader(false);
    if (res.success) {
      const a = document.createElement("a");
      a.href = res.url;
      a.download = "";
      document.body.appendChild(a);
      a.click();
      a.remove();
    } else {
      alert("‚ùå Error al generar: " + (res.error || "desconocido"));
    }
    delete window[cb];
  };

  const script = document.createElement("script");
  script.src = `${SCRIPT_GEN_URL}?oficio=${encodeURIComponent(oficio)}&type=${encodeURIComponent(type)}&callback=${cb}`;
  document.body.appendChild(script);
});

function goEdit(o){ location.href="edit.html?oficio="+encodeURIComponent(o); }

// üîπ Opcional: cuando tengamos ZIP funcionando
function genAllDocs(oficio){
  alert("ZIP de todos los documentos ‚ûú Ser√° activado en la siguiente fase ‚úÖ");
}

document.getElementById("next").onclick=()=>{start+=pageSize;loadPage();}
document.getElementById("prev").onclick=()=>{if(start>=pageSize) start-=pageSize;loadPage();}
document.getElementById("buscar").oninput=function(){
  const t=this.value.toLowerCase();
  document.querySelectorAll("#tbody tr").forEach(tr=>{
    tr.style.display=tr.innerText.toLowerCase().includes(t)?"":"none";
  });
}
document.getElementById("filtroRein").onchange=function(){
  const v=this.value;
  document.querySelectorAll("#tbody tr").forEach(tr=>{
    const est=tr.children[7]?.innerText.trim();
    tr.style.display=(v==="all")|| 
                     (v==="true" && est==="‚úÖ")||
                     (v==="false"&& est==="‚ùå")? "":"none";
  });
}

// Delegaci√≥n: manejar click en los iconos de descarga individual
document.addEventListener('click', function(evt){
  const btn = evt.target.closest('.download-single');
  if (!btn) return;

  // ubicamos el dropdown-content contenedor con data-oficio
  const dropdown = btn.closest('.dropdown-content');
  const oficio = dropdown ? dropdown.dataset.oficio : null;
  const type = btn.dataset.type;
  if (!oficio || !type) {
    return alert("No se pudo identificar el oficio o el tipo.");
  }

  showLoader(true, "Generando " + type + "...");

  const cb = "cb_single_" + Date.now();
  window[cb] = function(res){
    showLoader(false);
    if (res && res.success) {
      const a = document.createElement("a");
      a.href = res.url;
      a.download = "";
      document.body.appendChild(a);
      a.click();
      a.remove();
    } else {
      alert("Error al generar documento: " + (res && res.error ? res.error : "desconocido"));
      console.error("single-error", res);
    }
    delete window[cb];
  };

  const script = document.createElement("script");
  script.src = `${SCRIPT_GEN_URL}?oficio=${encodeURIComponent(oficio)}&type=${encodeURIComponent(type)}&callback=${cb}`;
  document.body.appendChild(script);
});

loadPage();

function logout(){
  localStorage.removeItem("session");
  location.href="login.html";
}
</script>
<!-- LOADER DE PANTALLA COMPLETA -->
<div id="loaderOverlay">
  <div class="spinner"></div>
  <p id="loaderText">Generando documento...</p>
</div>
</body>
</html>
