<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Registro de Comisión</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h1>Registro de Comisión</h1>
    <form id="formComision">
      <!-- 1 Oficio -->
      <label>Oficio</label>
      <input type="number" id="oficio" name="oficio" required>

      <!-- 2 Fecha -->
      <label>Fecha</label>
      <input type="date" id="fecha" name="fecha" required>

      <!-- 3 Nombre -->
      <label>Nombre</label>
      <input type="text" id="nombre" name="nombre" list="dlNombre">
      <datalist id="dlNombre"></datalist>

      <!-- 4 Puesto -->
      <label>Puesto</label>
      <input type="text" id="puesto" name="puesto" list="dlPuesto">
      <datalist id="dlPuesto"></datalist>

      <!-- 5 Tipo -->
      <label>Tipo</label>
      <select id="tipo" name="tipo" required>
        <option value="">Selecciona</option>
        <option value="Base">Base</option>
        <option value="Contrato">Contrato</option>
      </select>

      <!-- 6 Fecha inicial -->
      <label>Fecha inicial</label>
      <input type="date" id="fechaInicial" name="fechaInicial" required>

      <!-- 7 Fecha final -->
      <label>Fecha final</label>
      <input type="date" id="fechaFinal" name="fechaFinal" required>

      <!-- 8 Fechas de comisión (readonly) -->
      <label>Fechas de comisión</label>
      <input type="text" id="fechasComision" name="fechasComision" readonly>

      <!-- 9 Días de comisión (readonly) -->
      <label>Días de comisión</label>
      <input type="number" id="diasComision" name="diasComision" readonly>

      <!-- 10 Lugar -->
      <label>Lugar de comisión</label>
      <input type="text" id="lugar" name="lugar" list="dlLugar">
      <datalist id="dlLugar"></datalist>

      <!-- 11 Motivo -->
      <label>Motivo de comisión</label>
      <input type="text" id="motivo" name="motivo" list="dlMotivo">
      <datalist id="dlMotivo"></datalist>

      <!-- 12 Región -->
      <label>Región</label>
      <input type="text" id="region" name="region" list="dlRegion">
      <datalist id="dlRegion"></datalist>

      <!-- 13 Medio transporte -->
      <label>Medio de transporte</label>
      <select id="medioTransporte" name="medioTransporte">
        <option value="">Selecciona</option>
        <option value="Vehículo Oficial">Vehículo Oficial</option>
        <option value="Vehículo personal">Vehículo personal</option>
        <option value="Autobús">Autobús</option>
      </select>

      <div id="vehiculoWrap" style="display:none;">
        <label>Marca</label>
        <input type="text" id="marca" name="marca" list="dlMarca">
        <datalist id="dlMarca"></datalist>

        <label>Modelo</label>
        <input type="text" id="modelo" name="modelo" list="dlModelo">
        <datalist id="dlModelo"></datalist>

        <label>Placa</label>
        <input type="text" id="placa" name="placa" list="dlPlaca">
        <datalist id="dlPlaca"></datalist>
      </div>

      <!-- Autoriza -->
      <label>Autoriza</label>
      <input type="text" id="autoriza" name="autoriza" list="dlAutoriza">
      <datalist id="dlAutoriza"></datalist>

      <label>Puesto de quien autoriza</label>
      <input type="text" id="puestoAutoriza" name="puestoAutoriza" list="dlPuestoAutoriza">
      <datalist id="dlPuestoAutoriza"></datalist>

      <label>Vo.Bo.</label>
      <input type="text" id="vobo" name="vobo" list="dlVoBo">
      <datalist id="dlVoBo"></datalist>

      <label>Puesto Vo.Bo.</label>
      <input type="text" id="puestoVoBo" name="puestoVoBo" list="dlPuestoVoBo">
      <datalist id="dlPuestoVoBo"></datalist>

      <!-- Anticipado (compact) -->
      <h2>Anticipado</h2>
      <div class="compact-grid">
        <div><label>Alim.</label><input type="number" id="alimentacionAnt" name="alimentacionAnt" min="0" step="0.01" value="0"></div>
        <div><label>Hosp.</label><input type="number" id="hospedajeAnt" name="hospedajeAnt" min="0" step="0.01" value="0"></div>
        <div><label>Comb.</label><input type="number" id="combustibleAnt" name="combustibleAnt" min="0" step="0.01" value="0"></div>
        <div><label>Peaje</label><input type="number" id="peajeAnt" name="peajeAnt" min="0" step="0.01" value="0"></div>
        <div><label>Pasaj.</label><input type="number" id="pasajesAnt" name="pasajesAnt" min="0" step="0.01" value="0"></div>
        <div><label>Otros</label><input type="number" id="otrosAnt" name="otrosAnt" min="0" step="0.01" value="0"></div>
      </div>
      <label>Total anticipado</label>
      <input type="number" id="totalAnt" name="totalAnt" readonly>

      <!-- Devengado (compact) -->
      <h2>Devengado</h2>
      <div class="compact-grid">
        <div><label>Alim.</label><input type="number" id="alimentacionDev" name="alimentacionDev" min="0" step="0.01" value="0"></div>
        <div><label>Hosp.</label><input type="number" id="hospedajeDev" name="hospedajeDev" min="0" step="0.01" value="0"></div>
        <div><label>Comb.</label><input type="number" id="combustibleDev" name="combustibleDev" min="0" step="0.01" value="0"></div>
        <div><label>Peaje</label><input type="number" id="peajeDev" name="peajeDev" min="0" step="0.01" value="0"></div>
        <div><label>Pasaj.</label><input type="number" id="pasajesDev" name="pasajesDev" min="0" step="0.01" value="0"></div>
        <div><label>Otros</label><input type="number" id="otrosDev" name="otrosDev" min="0" step="0.01" value="0"></div>
      </div>
      <label>Total devengado</label>
      <input type="number" id="totalDev" name="totalDev" readonly>

      <!-- Fecha de anticipado -->
      <label>Fecha de anticipado</label>
      <input type="date" id="fechaAnticipado" name="fechaAnticipado">

      <!-- Fecha de comprobación (por defecto hoy) -->
      <label>Fecha de comprobación</label>
      <input type="date" id="fechaComprobacion" name="fechaComprobacion">

      <div class="buttons">
        <button type="submit">Guardar</button>
        <button type="button" id="btnHist">Ver Comisiones</button>
      </div>
    </form>
  </div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwffxZ1nt5blIKChONoUHKU6xdnPVbqn_4AgPipQiyOoBmjrLNoX6RQwLfYuSmePkm0Zg/exec"; // <-- reemplaza

const $ = id => document.getElementById(id);

// Utils
function isoToday() {
  const d = new Date();
  return new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().split("T")[0];
}

// cargar sugerencias y next oficio
async function cargarInicial() {
  // cargar sugerencias y next
  try {
    // sugerencias
    const s = await (await fetch(API_URL + "?action=sugerencias")).json();
    if (s && s.success && s.data) {
      const mapa = {
        nombre: "dlNombre", puesto: "dlPuesto", lugar: "dlLugar", motivo: "dlMotivo",
        region: "dlRegion", marca: "dlMarca", modelo: "dlModelo", placa: "dlPlaca",
        autoriza: "dlAutoriza", puestoAutoriza: "dlPuestoAutoriza", vobo: "dlVoBo", puestoVoBo: "dlPuestoVoBo"
      };
      for (const k in mapa) {
        const arr = s.data[k] || [];
        const dl = document.getElementById(mapa[k]);
        if (!dl) continue;
        dl.innerHTML = "";
        arr.forEach(v => { if (v) dl.appendChild(Object.assign(document.createElement("option"), { value: v })); });
      }
    }
    // next
    const nextR = await (await fetch(API_URL + "?action=next")).json();
    if (nextR && nextR.success) $("oficio").value = nextR.next || 1;
    else $("oficio").value = 1;
  } catch (err){ console.warn("init error", err); $("oficio").value = 1; }
  // fechas por defecto
  $("fecha").value = isoToday();
  $("fechaInicial").value = isoToday();
  $("fechaFinal").value = isoToday();
  $("fechaComprobacion").value = isoToday();
  $("fechaAnticipado").value = "";
  actualizarFechas(); calcTotalAnt(); calcTotalDev();
}

// eventos
function actualizarFechas(){
  const fi = new Date($("fechaInicial").value);
  const ff = new Date($("fechaFinal").value);
  if (isNaN(fi.getTime()) || isNaN(ff.getTime())) { $("fechasComision").value=""; $("diasComision").value=""; return; }
  $("fechasComision").value = $("fechaInicial").value + " a " + $("fechaFinal").value;
  const diff = Math.floor((ff - fi)/(1000*60*60*24));
  $("diasComision").value = diff >= 0 ? diff + 1 : 0;
}

function calcTotalAnt(){
  const ids = ["alimentacionAnt","hospedajeAnt","combustibleAnt","peajeAnt","pasajesAnt","otrosAnt"];
  let t=0; ids.forEach(id=> t += parseFloat($(id).value || 0));
  $("totalAnt").value = t.toFixed(2);
  if (t>0) $("fechaAnticipado").value = $("fecha").value;
}

function calcTotalDev(){
  const ids = ["alimentacionDev","hospedajeDev","combustibleDev","peajeDev","pasajesDev","otrosDev"];
  let t=0; ids.forEach(id=> t += parseFloat($(id).value || 0));
  $("totalDev").value = t.toFixed(2);
}

// listeners
document.addEventListener("DOMContentLoaded", ()=>{
  cargarInicial();
  $("fechaInicial").addEventListener("change", actualizarFechas);
  $("fechaFinal").addEventListener("change", actualizarFechas);
  ["alimentacionAnt","hospedajeAnt","combustibleAnt","peajeAnt","pasajesAnt","otrosAnt"].forEach(id=>$(id).addEventListener("input", calcTotalAnt));
  ["alimentacionDev","hospedajeDev","combustibleDev","peajeDev","pasajesDev","otrosDev"].forEach(id=>$(id).addEventListener("input", calcTotalDev));
  $("medioTransporte").addEventListener("change", ()=> { $("vehiculoWrap").style.display = ($("medioTransporte").value==="Vehículo Oficial") ? "block" : "none"; });
  $("btnHist").addEventListener("click", ()=> location.href = "historial.html");

  $("formComision").addEventListener("submit", async (e)=>{
    e.preventDefault();
    // build payload matching Code.gs fields
    const payload = {
      mode: "create",
      oficio: $("oficio").value,
      fecha: $("fecha").value,
      nombre: $("nombre").value,
      puesto: $("puesto").value,
      tipo: $("tipo").value,
      fechaInicial: $("fechaInicial").value,
      fechaFinal: $("fechaFinal").value,
      lugar: $("lugar").value,
      motivo: $("motivo").value,
      region: $("region").value,
      mediotransporte: $("medioTransporte").value,
      marca: $("marca").value,
      modelo: $("modelo").value,
      placa: $("placa").value,
      autoriza: $("autoriza").value,
      puestoAutoriza: $("puestoAutoriza").value,
      vobo: $("vobo").value,
      puestoVoBo: $("puestoVoBo").value,
      alimentacionAnt: $("alimentacionAnt").value || 0,
      hospedajeAnt: $("hospedajeAnt").value || 0,
      combustibleAnt: $("combustibleAnt").value || 0,
      peajeAnt: $("peajeAnt").value || 0,
      pasajesAnt: $("pasajesAnt").value || 0,
      otrosAnt: $("otrosAnt").value || 0,
      alimentacionDev: $("alimentacionDev").value || 0,
      hospedajeDev: $("hospedajeDev").value || 0,
      combustibleDev: $("combustibleDev").value || 0,
      peajeDev: $("peajeDev").value || 0,
      pasajesDev: $("pasajesDev").value || 0,
      otrosDev: $("otrosDev").value || 0,
      fechaAnticipado: $("fechaAnticipado").value || "",
      fechaComprobacion: $("fechaComprobacion").value || ""
    };
    // compute totals clientside (server also computes)
    payload.totalAnt = $("totalAnt").value || 0;
    payload.totalDev = $("totalDev").value || 0;

    try {
      const res = await fetch(API_URL, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      const j = await res.json();
      if (j && j.success) { alert("Guardado ✅"); location.href = "historial.html"; }
      else { alert("Error: " + (j.error || j.message || "desconocido")); }
    } catch(err){
      console.error(err); alert("Error de conexión al guardar");
    }
  });
});
</script>
</body>
</html>













