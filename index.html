<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="style.css">
<link rel="icon" type="image/png" href="favicon.png">
<link rel="shortcut icon" href="favicon.ico">
<title>Registro de Comisión</title>
</head>
<body>
  <div class="header-bar">
  SUBSECRETARÍA DE EDUCACIÓN BÁSICA – MICHOACÁN
</div>
  <div class="card">
    <img src="logo.png" alt="Logo SEB" class="logo">
    <h1>Registro de Comisión</h1>
    
    <form id="form">
      <div class="row">
        <div class="col">
          <label>Número de Oficio</label>
          <input id="oficio" name="oficio" type="text" required>
          <div class="hint">Se propone un número automático; puedes editarlo. Si ya existe al guardar, se rechazará.</div>
        </div>
        <div class="col">
          <label>Fecha</label>
          <input id="fecha" name="fecha" type="date" required>
        </div>
        <div class="col">
          <label>Tipo</label>
          <select id="tipo" name="tipo" required>
            <option value="base">Base</option>
            <option value="contrato">Contrato</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Nombre</label>
          <input id="nombre" name="nombre" list="dlNombre" required>
          <datalist id="dlNombre"></datalist>
        </div>
        <div class="col">
          <label>Puesto</label>
          <input id="puesto" name="puesto" list="dlPuesto" required>
          <datalist id="dlPuesto"></datalist>
        </div>
        <div class="col">
          <label>Región</label>
          <input id="region" name="region" list="dlRegion">
          <datalist id="dlRegion"></datalist>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Fecha inicio de comisión</label>
          <input id="fechaInicio" name="fechaInicio" type="date" required>
        </div>
        <div class="col">
          <label>Fecha fin de comisión</label>
          <input id="fechaFin" name="fechaFin" type="date" required>
        </div>
        <div class="col">
          <label>Fechas de comisión</label>
          <input id="fechasComision" name="fechas_comision" type="text" readonly class="readonly">
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Días de comisión</label>
          <input id="diasComision" name="dias_comision" type="number" readonly class="readonly">
        </div>
        <div class="col">
          <label>Lugar de comisión</label>
          <input id="lugar" name="lugar" list="dlLugar" required>
          <datalist id="dlLugar"></datalist>
        </div>
        <div class="col">
          <label>Motivo de comisión</label>
          <input id="motivo" name="motivo" list="dlMotivo">
          <datalist id="dlMotivo"></datalist>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Medio de transporte</label>
          <select id="medio" name="medio_transporte">
            <option value="Vehículo Oficial">Vehículo Oficial</option>
            <option value="Vehículo personal">Vehículo personal</option>
            <option value="Autobús">Autobús</option>
          </select>
        </div>
        <div class="col">
          <label>Marca</label>
          <input id="marca" name="marca" list="dlMarca">
          <datalist id="dlMarca"></datalist>
        </div>
        <div class="col">
          <label>Modelo</label>
          <input id="modelo" name="modelo" list="dlModelo">
          <datalist id="dlModelo"></datalist>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Placa</label>
          <input id="placa" name="placa" list="dlPlaca">
          <datalist id="dlPlaca"></datalist>
        </div>
        <div class="col">
          <label>Autoriza</label>
          <input id="autoriza" name="autoriza" list="dlAutoriza">
          <datalist id="dlAutoriza"></datalist>
        </div>
        <div class="col">
          <label>Puesto de quien autoriza</label>
          <input id="puestoAutoriza" name="puesto_autoriza" list="dlPuestoAutoriza">
          <datalist id="dlPuestoAutoriza"></datalist>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Vo.Bo.</label>
          <input id="vobo" name="vobo" list="dlVoBo">
          <datalist id="dlVoBo"></datalist>
        </div>
        <div class="col">
          <label>Puesto Vo.Bo.</label>
          <input id="puestoVoBo" name="puesto_vobo" list="dlPuestoVoBo">
          <datalist id="dlPuestoVoBo"></datalist>
        </div>
      </div>

      <!-- Anticipado -->
      <div class="section">
        <strong>Anticipado</strong>
        <div class="grid" style="margin-top:8px">
          <div><label>Alimentación (MXN)</label><input id="antAlim" name="alim_antic" type="number" min="0" step="0.01"></div>
          <div><label>Hospedaje (MXN)</label><input id="antHosp" name="hosp_antic" type="number" min="0" step="0.01"></div>
          <div><label>Combustible (MXN)</label><input id="antComb" name="comb_antic" type="number" min="0" step="0.01"></div>
          <div><label>Peaje (MXN)</label><input id="antPeaje" name="peaje_antic" type="number" min="0" step="0.01"></div>
          <div><label>Pasajes (MXN)</label><input id="antPas" name="pasajes_antic" type="number" min="0" step="0.01"></div>
          <div><label>Otros (MXN)</label><input id="antOtros" name="otros_antic" type="number" min="0" step="0.01"></div>
        </div>

        <div class="totals">
          <div class="box">
            <div class="small">Total anticipado</div>
            <div id="totalAntDisplay">$0.00</div>
          </div>
          <div class="box2">
            <div class="small">Fecha de anticipado</div>
            <input id="fechaAnt" name="fecha_antic" type="date">
          </div>
        </div>
      </div>

      <!-- Devengado -->
      <div class="section">
        <strong>Devengado</strong>
        <div class="grid" style="margin-top:8px">
          <div><label>Alimentación (MXN)</label><input id="devAlim" name="alim_dev" type="number" min="0" step="0.01"></div>
          <div><label>Hospedaje (MXN)</label><input id="devHosp" name="hosp_dev" type="number" min="0" step="0.01"></div>
          <div><label>Combustible (MXN)</label><input id="devComb" name="comb_dev" type="number" min="0" step="0.01"></div>
          <div><label>Peaje (MXN)</label><input id="devPeaje" name="peaje_dev" type="number" min="0" step="0.01"></div>
          <div><label>Pasajes (MXN)</label><input id="devPas" name="pasajes_dev" type="number" min="0" step="0.01"></div>
          <div><label>Otros (MXN)</label><input id="devOtros" name="otros_dev" type="number" min="0" step="0.01"></div>
        </div>

        <div class="totals">
          <div class="box">
            <div class="small">Total devengado</div>
            <div id="totalDevDisplay">$0.00</div>
          </div>
          <div class="box2">
            <div class="small">Fecha de comprobación</div>
            <input id="fechaComp" name="fecha_comprobacion" type="date">
          </div>
          <div class="row" style="margin-top:8px;">
            <div class="box2">
              <label style="text-align: center;" title="Marca si se realizo Reintegro o Depósito">
              <input type="checkbox" id="reintegro" name="reintegro_deposito">
              <strong>Reint/Dep</strong>
          </label>
  </div>
</div>
        </div>
      </div>

      <div class="actions">
        <button type="submit">Guardar</button>
        <button type="button" onclick="location.href='historial.html'">Ver comisiones</button>
        <button id="salir" onclick="logout()" style="margin-left:auto;">Salir</button>
      </div>
    </form>
  </div>

<script>

function checkSession(){
  const s = JSON.parse(localStorage.getItem("session") || "{}");
  if(!s.usuario || !s.rol || !s.exp) return location.href="login.html";
  if(Date.now() > s.exp){
    localStorage.removeItem("session");
    return location.href="login.html";
  }
}
checkSession();
const ses = JSON.parse(localStorage.getItem("session"));
if(ses.rol == "consulta"){
  document.querySelectorAll('input,select,textarea').forEach(el=>{
    if(el.id !== "salir") el.disabled = true;
  });
  document.querySelector('button[type="submit"]').disabled = true;
}
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyOB-68HNJbUPuwd1wDkPJDnrxPDAMWCsaOVFN8n6JIQWnXbqlwszOtJ3YQZIVzG3Dwvg/exec";
const $ = id => document.getElementById(id);

// ===== JSONP: obtener max oficio =====
function onMaxOficio(res){
  if(res && res.next){
    $('oficio').value = res.next;
  } else {
    $('oficio').value = "1";
  }
}
function loadMaxOficio(){
  const s = document.createElement('script');
  s.src = SCRIPT_URL + "?maxoficio=1&callback=onMaxOficio";
  document.body.appendChild(s);
}

// ===== JSONP: sugerencias =====
function onSuggestions(res){
  const fill = (id, arr) => {
    const dl = $(id);
    if(!dl) return;
    dl.innerHTML = "";
    (arr||[]).forEach(v=>{
      const opt=document.createElement('option');
      opt.value=v;
      dl.appendChild(opt);
    });
  };

  fill('dlNombre',res.nombre);
  fill('dlPuesto',res.puesto);
  fill('dlLugar',res.lugar);
  fill('dlMotivo',res.motivo);
  fill('dlRegion',res.region);
  fill('dlMarca',res.marca);
  fill('dlModelo',res.modelo);
  fill('dlPlaca',res.placa);
  fill('dlAutoriza',res.autoriza);
  fill('dlPuestoAutoriza',res.puesto_autoriza);
  fill('dlVoBo',res.vobo);
  fill('dlPuestoVoBo',res.puesto_vobo);
}
function loadSuggestions(){
  const s = document.createElement('script');
  s.src = SCRIPT_URL + "?suggestions=1&callback=onSuggestions";
  document.body.appendChild(s);
}

// ===== Fechas iniciales =====
function setInitialDates(){
  const now = new Date();
  const offset = now.getTimezoneOffset()*60000;
  const local = new Date(now.getTime()-offset);
  const d = local.toISOString().slice(0,10);
  $('fecha').value = d;
  $('fechaInicio').value = d;
  $('fechaFin').value = d;
  $('fechaComp').value = d;
  $('fechaAnt').value = d;
}

// ===== Fechas comisión y días =====
function updateFechas(){
  const f1 = $('fechaInicio').value, f2 = $('fechaFin').value;
  if (f1 && f2) {
    const [anio1, mes1, dia1] = f1.split('-').map(Number);
    const [anio2, mes2, dia2] = f2.split('-').map(Number);
    const d1 = new Date(anio1, mes1 - 1, dia1);
    const d2 = new Date(anio2, mes2 - 1, dia2);
    if (!isNaN(d1.getTime()) && !isNaN(d2.getTime())) {
      const meses = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];
      const f1L = d1.getDate() + " de " + meses[d1.getMonth()] + " de " + d1.getFullYear();
      const f2L = d2.getDate() + " de " + meses[d2.getMonth()] + " de " + d2.getFullYear();
      $('fechasComision').value = f1L + " al " + f2L;
      const diff = Math.round((d2 - d1)/(1000*60*60*24)) + 1;
      $('diasComision').value = diff >= 0 ? diff : 0;
    }
  }
}

// ===== Totales =====
function updateTotales(){
  const idsA = ['antAlim','antHosp','antComb','antPeaje','antPas','antOtros'];
  const idsD = ['devAlim','devHosp','devComb','devPeaje','devPas','devOtros'];
  let tA=0,tD=0;
  idsA.forEach(i=>tA+=Number($(i).value||0));
  idsD.forEach(i=>tD+=Number($(i).value||0));
  $('totalAntDisplay').textContent = '$' + tA.toFixed(2);
  $('totalDevDisplay').textContent = '$' + tD.toFixed(2);

  if(tA>0){
    $('fechaAnt').value = $('fecha').value;
    $('fechaAnt').readOnly = true;
  } else {
    $('fechaAnt').readOnly = false;
  }
}

// ===== Vehículo oficial toggler =====
function toggleVehiculo(){
  const dis = $('medio').value !== "Vehículo Oficial";
  ['marca','modelo','placa'].forEach(id=>{ $(id).disabled=dis; if(dis) $(id).value=""; });
}

// ===== Validar oficio =====
function ensureOficio(){
  const val = $('oficio').value.trim();
  return val.length>0;
}

// ===== Capturar usuario que guarda el oficio =====
function getUsuarioActual() {
  const s = JSON.parse(localStorage.getItem("session") || "{}");
  return s?.nombre || s?.usuario || "Desconocido";
}

// ===== Guardar =====
$('form').addEventListener('submit', async e=>{
  e.preventDefault();

  if(!ensureOficio()){
    alert("⚠️ El número de oficio es requerido");
    return;
  }

  const fd = new FormData(e.target);
  fd.set("_method","create");

  fd.set('reintegro_deposito', $('reintegro').checked ? 'TRUE' : 'FALSE');

  fd.set("capturado_por", getUsuarioActual());

  const r = await fetch(SCRIPT_URL, { method:"POST", body:fd });
  const j = await r.json().catch(()=>({}));

  if(j.success){
    alert("✅ Guardado correctamente");
    e.target.reset();
    setInitialDates();
    updateTotales();
    updateFechas();
    loadMaxOficio();
    loadSuggestions();
  } else {
    alert("❌ Error: "+(j.error||'desconocido'));
  }
});

// ===== Inicializar =====
setInitialDates();
loadMaxOficio();
loadSuggestions();
updateFechas();
updateTotales();
toggleVehiculo();

['fechaInicio','fechaFin'].forEach(id=>$(id).addEventListener('change',updateFechas));
['antAlim','antHosp','antComb','antPeaje','antPas','antOtros','devAlim','devHosp','devComb','devPeaje','devPas','devOtros','fecha'].forEach(id=>{
  $(id).addEventListener('input',updateTotales);
});
$('medio').addEventListener('change',toggleVehiculo);
function logout(){
  localStorage.removeItem("session");
  location.href="login.html";
}
</script>
</body>
</html>
