<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Editar Comisión</title>
<style>
  :root{--accent:#0b63a7;--muted:#6b7280;--bg:#f3f6f8}
  body{font-family:Inter,system-ui,Arial;background:var(--bg);margin:0;padding:20px;color:#0b1823}
  .card{max-width:980px;margin:12px auto;background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 20px rgba(10,10,10,0.06)}
  h1{color:var(--accent);margin:0 0 10px}
  label{display:block;font-weight:600;margin-top:10px;font-size:0.95rem}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1;min-width:180px}
  input,select,textarea{width:100%;padding:9px;border-radius:8px;border:1px solid #e6eef6;font-size:14px}
  textarea{min-height:64px}
  .section{margin-top:14px;padding:12px;border-radius:8px;background:#fbfdff;border:1px solid #eef5fb}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px}
  .totals{display:flex;gap:10px;align-items:center;margin-top:10px}
  .totals .box{flex:1;padding:10px;border-radius:8px;background:#fff;border:1px solid #e9f2fb;text-align:center}
  .actions{display:flex;gap:10px;margin-top:14px}
  button{background:var(--accent);color:#fff;padding:10px 14px;border-radius:8px;border:0;cursor:pointer}
  button.ghost{background:#6b7280}
  .hint{font-size:12px;color:var(--muted);margin-top:4px}
  .readonly{background:#f6f8fa}
  .small{font-size:13px;color:var(--muted)}
  @media (max-width:700px){
    .row{flex-direction:column}
  }
</style>
</head>
<body>
  <div class="card">
    <h1>Editar Comisión</h1>
    <form id="form">
      <div class="row">
        <div class="col">
          <label>Número de Oficio</label>
          <input id="oficio" name="oficio" type="text" readonly>
        </div>
        <div class="col">
          <label>Fecha</label>
          <input id="fecha" name="fecha" type="date">
        </div>
        <div class="col">
          <label>Tipo</label>
          <select id="tipo" name="tipo">
            <option value="base">Base</option>
            <option value="contrato">Contrato</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Nombre</label>
          <input id="nombre" name="nombre">
        </div>
        <div class="col">
          <label>Puesto</label>
          <input id="puesto" name="puesto">
        </div>
        <div class="col">
          <label>Región</label>
          <input id="region" name="region">
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Fecha inicio</label>
          <input id="fechaInicio" name="fechaInicio" type="date">
        </div>
        <div class="col">
          <label>Fecha fin</label>
          <input id="fechaFin" name="fechaFin" type="date">
        </div>
        <div class="col">
          <label>Fechas de comisión (lectura)</label>
          <input id="fechasComision" readonly class="readonly">
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Días de comisión</label>
          <input id="diasComision" name="dias_comision" readonly class="readonly">
        </div>
        <div class="col">
          <label>Lugar</label>
          <input id="lugar" name="lugar">
        </div>
        <div class="col">
          <label>Motivo</label>
          <input id="motivo" name="motivo">
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Medio de transporte</label>
          <select id="medio" name="medio_transporte">
            <option value="Vehículo Oficial">Vehículo Oficial</option>
            <option value="Vehículo personal">Vehículo personal</option>
            <option value="Autobús">Autobús</option>
          </select>
        </div>
        <div class="col">
          <label>Marca</label>
          <input id="marca" name="marca">
        </div>
        <div class="col">
          <label>Modelo</label>
          <input id="modelo" name="modelo">
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Placa</label>
          <input id="placa" name="placa">
        </div>
        <div class="col">
          <label>Autoriza</label>
          <input id="autoriza" name="autoriza">
        </div>
        <div class="col">
          <label>Puesto de quien autoriza</label>
          <input id="puestoAutoriza" name="puesto_autoriza">
        </div>
      </div>

      <div class="section">
        <strong>Anticipado</strong>
        <div class="grid" style="margin-top:8px">
          <div><label>Alimentación</label><input id="antAlim" name="alim_antic" type="number" min="0" step="0.01"></div>
          <div><label>Hospedaje</label><input id="antHosp" name="hosp_antic" type="number" min="0" step="0.01"></div>
          <div><label>Combustible</label><input id="antComb" name="comb_antic" type="number" min="0" step="0.01"></div>
          <div><label>Peaje</label><input id="antPeaje" name="peaje_antic" type="number" min="0" step="0.01"></div>
          <div><label>Pasajes</label><input id="antPas" name="pasajes_antic" type="number" min="0" step="0.01"></div>
          <div><label>Otros</label><input id="antOtros" name="otros_antic" type="number" min="0" step="0.01"></div>
        </div>
        <div class="totals">
          <div class="box"><div class="small">Total anticipado</div><div id="totalAntDisplay">$0.00</div></div>
          <div class="box"><div class="small">Fecha anticipado</div><input id="fechaAnt" name="fecha_antic" type="date"></div>
        </div>
      </div>

      <div class="section">
        <strong>Devengado</strong>
        <div class="grid" style="margin-top:8px">
          <div><label>Alimentación</label><input id="devAlim" name="alim_dev" type="number" min="0" step="0.01"></div>
          <div><label>Hospedaje</label><input id="devHosp" name="hosp_dev" type="number" min="0" step="0.01"></div>
          <div><label>Combustible</label><input id="devComb" name="comb_dev" type="number" min="0" step="0.01"></div>
          <div><label>Peaje</label><input id="devPeaje" name="peaje_dev" type="number" min="0" step="0.01"></div>
          <div><label>Pasajes</label><input id="devPas" name="pasajes_dev" type="number" min="0" step="0.01"></div>
          <div><label>Otros</label><input id="devOtros" name="otros_dev" type="number" min="0" step="0.01"></div>
        </div>
        <div class="totals">
          <div class="box"><div class="small">Total devengado</div><div id="totalDevDisplay">$0.00</div></div>
          <div class="box"><div class="small">Fecha comprobación</div><input id="fechaComp" name="fecha_comprobacion" type="date"></div>
        </div>
      </div>

      <div class="actions">
        <button type="submit">Guardar cambios</button>
        <button type="button" class="ghost" onclick="location.href='historial.html'">Volver</button>
        <button id="salir" onclick="logout()" style="margin-left:auto;">Salir</button>
      </div>
    </form>
  </div>

<script>
  
function checkSession(){
  const s = JSON.parse(localStorage.getItem("session") || "{}");
  if(!s.usuario || !s.rol || !s.exp) return location.href="login.html";
  if(Date.now() > s.exp){
    localStorage.removeItem("session");
    return location.href="login.html";
  }
}
checkSession();
const ses = JSON.parse(localStorage.getItem("session"));
if(ses.rol !== "admin"){
  document.querySelectorAll('input,select,textarea').forEach(el=>{
    if(el.id !== "salir") el.disabled = true;
  });
  document.querySelector('button[type="submit"]').disabled = true;
}
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwax7IHudPuBzVilnAxdlTbB0xQXF-WgzRtwNkQBTSvU3dllWIKOjzs8-iME312CqlzKg/exec";
const $ = id => document.getElementById(id);
const toMoney = n => Number(n||0).toLocaleString('es-MX',{minimumFractionDigits:2});

/* UTIL: convierte fecha larga en español "27 de octubre de 2025" -> ISO yyyy-mm-dd */
function parseESLongToISO(s){
  if(!s) return "";
  const meses = {enero:0,febrero:1,marzo:2,abril:3,mayo:4,junio:5,julio:6,agosto:7,septiembre:8,octubre:9,noviembre:10,diciembre:11};
  const m = s.toString().match(/(\d{1,2})\s+de\s+([a-záéíóúñ]+)\s+de\s+(\d{4})/i);
  if(!m) return "";
  const d = Number(m[1]), mo = meses[m[2].toLowerCase()], y = Number(m[3]);
  if (mo === undefined) return "";
  const dt = new Date(y,mo,d);
  return dt.toISOString().slice(0,10);
}

/* Añade un tag <script> para JSONP */
function addJSONP(q){ const s=document.createElement('script'); s.src = SCRIPT_URL + q; document.body.appendChild(s); }

/* obtener param de URL */
function getParam(name){ return new URLSearchParams(location.search).get(name); }

/* Si cadena vacía -> devuelve ISO de hoy local */
function todayISOIfEmpty(value){
  if (value && value.toString().trim() !== "") return value;
  const now = new Date();
  const local = new Date(now.getTime() - now.getTimezoneOffset()*60000);
  return local.toISOString().slice(0,10);
}

/* Cargar registro por oficio */
function loadRecord(){
  const oficio = getParam('oficio');
  if(!oficio) { alert('Falta oficio en la URL'); return; }
  // callback onData
  addJSONP('?get=' + encodeURIComponent(oficio) + '&callback=onData');
}

/* Llenar campos con datos recibidos */
function onData(data){
  if(!data) return alert('No se encontró el oficio');

  // oficio (readonly)
  $('oficio').value = data.oficio || '';

  // Fecha (largo)-> convertir a ISO para input; si no existe, usar hoy
  $('fecha').value = todayISOIfEmpty(parseESLongToISO(data.fecha));

  $('tipo').value = data.tipo || 'base';
  $('nombre').value = data.nombre || '';
  $('puesto').value = data.puesto || '';
  $('region').value = data.region || '';

  // fechas inicio/fin -> ISO; si faltan poner hoy
  $('fechaInicio').value = todayISOIfEmpty(parseESLongToISO(data.fecha_inicio));
  $('fechaFin').value = todayISOIfEmpty(parseESLongToISO(data.fecha_fin));

  // fechas de comision (texto largo), dias
  $('fechasComision').value = data.fechas_comision || '';
  $('diasComision').value = data.dias_comision || '';

  $('lugar').value = data.lugar || '';
  $('motivo').value = data.motivo || '';
  $('medio').value = data.medio_transporte || 'Vehículo Oficial';
  $('marca').value = data.marca || '';
  $('modelo').value = data.modelo || '';
  $('placa').value = data.placa || '';
  $('autoriza').value = data.autoriza || '';
  $('puestoAutoriza').value = data.puesto_autoriza || '';

  // anticipados
  $('antAlim').value = (data.alim_antic !== undefined && data.alim_antic !== '') ? data.alim_antic : 0;
  $('antHosp').value = (data.hosp_antic !== undefined && data.hosp_antic !== '') ? data.hosp_antic : 0;
  $('antComb').value = (data.comb_antic !== undefined && data.comb_antic !== '') ? data.comb_antic : 0;
  $('antPeaje').value = (data.peaje_antic !== undefined && data.peaje_antic !== '') ? data.peaje_antic : 0;
  $('antPas').value = (data.pasajes_antic !== undefined && data.pasajes_antic !== '') ? data.pasajes_antic : 0;
  $('antOtros').value = (data.otros_antic !== undefined && data.otros_antic !== '') ? data.otros_antic : 0;

  // devengados
  $('devAlim').value = (data.alim_dev !== undefined && data.alim_dev !== '') ? data.alim_dev : 0;
  $('devHosp').value = (data.hosp_dev !== undefined && data.hosp_dev !== '') ? data.hosp_dev : 0;
  $('devComb').value = (data.comb_dev !== undefined && data.comb_dev !== '') ? data.comb_dev : 0;
  $('devPeaje').value = (data.peaje_dev !== undefined && data.peaje_dev !== '') ? data.peaje_dev : 0;
  $('devPas').value = (data.pasajes_dev !== undefined && data.pasajes_dev !== '') ? data.pasajes_dev : 0;
  $('devOtros').value = (data.otros_dev !== undefined && data.otros_dev !== '') ? data.otros_dev : 0;

  // fechaAnt, fechaComp: if missing set to today
  $('fechaAnt').value = todayISOIfEmpty(parseESLongToISO(data.fecha_antic));
  $('fechaComp').value = todayISOIfEmpty(parseESLongToISO(data.fecha_comprobacion));

  updateTotalsAndDates();
  toggleVehiculo();
}

/* recalculo totales y fechas */
function updateTotalsAndDates(){
  const antIds = ['antAlim','antHosp','antComb','antPeaje','antPas','antOtros'];
  const devIds = ['devAlim','devHosp','devComb','devPeaje','devPas','devOtros'];
  let tA = 0, tD = 0;
  antIds.forEach(id => tA += Number($(id).value || 0));
  devIds.forEach(id => tD += Number($(id).value || 0));
  $('totalAntDisplay').textContent = '$' + toMoney(tA);
  $('totalDevDisplay').textContent = '$' + toMoney(tD);

  if (tA > 0) {
    $('fechaAnt').value = $('fecha').value || todayISOIfEmpty();
    $('fechaAnt').readOnly = true;
  } else {
    $('fechaAnt').readOnly = false;
  }

  // fechas comisión y días
  const f1 = $('fechaInicio').value, f2 = $('fechaFin').value;
  if (f1 && f2) {
    const d1 = new Date(f1), d2 = new Date(f2);
    if (!isNaN(d1.getTime()) && !isNaN(d2.getTime())) {
      const meses = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];
      const f1L = d1.getDate() + " de " + meses[d1.getMonth()] + " de " + d1.getFullYear();
      const f2L = d2.getDate() + " de " + meses[d2.getMonth()] + " de " + d2.getFullYear();
      $('fechasComision').value = f1L + " - " + f2L;
      const diff = Math.round((d2 - d1)/(1000*60*60*24)) + 1;
      $('diasComision').value = diff >= 0 ? diff : 0;
    }
  }
}

/* toggle vehiculo */
function toggleVehiculo(){
  const disable = $('medio').value !== "Vehículo Oficial";
  ['marca','modelo','placa'].forEach(id => {
    $(id).disabled = disable;
    if (disable) $(id).value = $(id).value || "";
  });
}

/* submit: actualizar (fecha comprobación se pone a hoy) */
/* IMPORTANT: send URLSearchParams object as body (not string), so Apps Script receives parameters in e.parameter */
document.getElementById('form').addEventListener('submit', async function(e){
  e.preventDefault();

  // Ensure oficio exists
  const oficioVal = $('oficio').value && $('oficio').value.toString().trim();
  if(!oficioVal){
    alert('❌ Oficio vacío — no se puede actualizar');
    return;
  }

  // preparar FormData (leer valores actuales)
  const fm = new FormData(this);
  fm.set('_method','update');

  // recalcular totales por seguridad
  const totalA = ['antAlim','antHosp','antComb','antPeaje','antPas','antOtros'].reduce((s,id)=>s+Number($(id).value||0),0);
  const totalD = ['devAlim','devHosp','devComb','devPeaje','devPas','devOtros'].reduce((s,id)=>s+Number($(id).value||0),0);
  fm.set('total_antic', totalA);
  fm.set('total_dev', totalD);

  // actualizar fecha_comprobacion a hoy (opción 1)
  const now = new Date();
  const localISO = new Date(now.getTime() - now.getTimezoneOffset()*60000).toISOString().slice(0,10);
  fm.set('fecha_comprobacion', localISO);

  // Convertir FormData a URLSearchParams (NO llamar .toString())
  const params = new URLSearchParams();
  for (const pair of fm.entries()) params.append(pair[0], pair[1]);

  try {
    const resp = await fetch(SCRIPT_URL, { method:'POST', body: params }); // <--- enviar URLSearchParams DIRECTO
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    const json = await resp.json();
    if (json.success) {
      alert('✅ Actualizado correctamente');
      location.href = 'historial.html';
    } else {
      alert('❌ Error: ' + (json.error || 'desconocido'));
    }
  } catch (err) {
    console.error('Error al guardar:', err);
    alert('Error al guardar (ver consola).');
  }
});

/* eventos */
['antAlim','antHosp','antComb','antPeaje','antPas','antOtros','devAlim','devHosp','devComb','devPeaje','devPas','devOtros','fecha','fechaInicio','fechaFin'].forEach(id=>{
  const el = $(id);
  if (el) el.addEventListener('input', updateTotalsAndDates);
});
$('medio').addEventListener('change', toggleVehiculo);

/* inicio */
loadRecord();
function logout(){
  localStorage.removeItem("session");
  location.href="login.html";
}
</script>
</body>
</html>
