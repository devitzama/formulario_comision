<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="style.css">
<title>Editar Comisión</title>
</head>
<body>
  <div class="header-bar">
  SUBSECRETARÍA DE EDUCACIÓN BÁSICA – MICHOACÁN
  </div>
  <div class="card">
    <img src="logo.png" alt="Logo SEB" class="logo">
    <h1>Editar Comisión</h1>
    <form id="form">
      <div class="row">
        <div class="col">
          <label>Número de Oficio</label>
          <input id="oficio" name="oficio" type="text" readonly>
        </div>
        <div class="col">
          <label>Fecha</label>
          <input id="fecha" name="fecha" type="date">
        </div>
        <div class="col">
          <label>Tipo</label>
          <select id="tipo" name="tipo">
            <option value="base">Base</option>
            <option value="contrato">Contrato</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Nombre</label>
          <input id="nombre" name="nombre">
        </div>
        <div class="col">
          <label>Puesto</label>
          <input id="puesto" name="puesto">
        </div>
        <div class="col">
          <label>Región</label>
          <input id="region" name="region">
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Fecha inicio</label>
          <input id="fechaInicio" name="fechaInicio" type="date">
        </div>
        <div class="col">
          <label>Fecha fin</label>
          <input id="fechaFin" name="fechaFin" type="date">
        </div>
        <div class="col">
          <label>Fechas de comisión (lectura)</label>
          <input id="fechasComision" readonly class="readonly">
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Días de comisión</label>
          <input id="diasComision" name="dias_comision" readonly class="readonly">
        </div>
        <div class="col">
          <label>Lugar</label>
          <input id="lugar" name="lugar">
        </div>
        <div class="col">
          <label>Motivo</label>
          <input id="motivo" name="motivo">
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Medio de transporte</label>
          <select id="medio" name="medio_transporte">
            <option value="Vehículo Oficial">Vehículo Oficial</option>
            <option value="Vehículo personal">Vehículo personal</option>
            <option value="Autobús">Autobús</option>
          </select>
        </div>
        <div class="col">
          <label>Marca</label>
          <input id="marca" name="marca">
        </div>
        <div class="col">
          <label>Modelo</label>
          <input id="modelo" name="modelo">
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Placa</label>
          <input id="placa" name="placa">
        </div>
        <div class="col">
          <label>Autoriza</label>
          <input id="autoriza" name="autoriza">
        </div>
        <div class="col">
          <label>Puesto de quien autoriza</label>
          <input id="puestoAutoriza" name="puesto_autoriza">
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Vo.Bo.</label>
          <input id="vobo" name="vobo">
        </div>
        <div class="col">
          <label>Puesto Vo.Bo.</label>
          <input id="puestoVoBo" name="puesto_vobo">
        </div>
      </div>

      <div class="section">
        <strong>Anticipado</strong>
        <div class="grid" style="margin-top:8px">
          <div><label>Alimentación</label><input id="antAlim" name="alim_antic" type="number" min="0" step="0.01"></div>
          <div><label>Hospedaje</label><input id="antHosp" name="hosp_antic" type="number" min="0" step="0.01"></div>
          <div><label>Combustible</label><input id="antComb" name="comb_antic" type="number" min="0" step="0.01"></div>
          <div><label>Peaje</label><input id="antPeaje" name="peaje_antic" type="number" min="0" step="0.01"></div>
          <div><label>Pasajes</label><input id="antPas" name="pasajes_antic" type="number" min="0" step="0.01"></div>
          <div><label>Otros</label><input id="antOtros" name="otros_antic" type="number" min="0" step="0.01"></div>
        </div>
        <div class="totals">
          <div class="box"><div class="small">Total anticipado</div><div id="totalAntDisplay">$0.00</div></div>
          <div class="box2"><div class="small">Fecha anticipado</div><input id="fechaAnt" name="fecha_antic" type="date"></div>
        </div>
      </div>

      <div class="section">
        <strong>Devengado</strong>
        <div class="grid" style="margin-top:8px">
          <div><label>Alimentación</label><input id="devAlim" name="alim_dev" type="number" min="0" step="0.01"></div>
          <div><label>Hospedaje</label><input id="devHosp" name="hosp_dev" type="number" min="0" step="0.01"></div>
          <div><label>Combustible</label><input id="devComb" name="comb_dev" type="number" min="0" step="0.01"></div>
          <div><label>Peaje</label><input id="devPeaje" name="peaje_dev" type="number" min="0" step="0.01"></div>
          <div><label>Pasajes</label><input id="devPas" name="pasajes_dev" type="number" min="0" step="0.01"></div>
          <div><label>Otros</label><input id="devOtros" name="otros_dev" type="number" min="0" step="0.01"></div>
        </div>
        <div class="totals">
          <div class="box"><div class="small">Total devengado</div><div id="totalDevDisplay">$0.00</div></div>
          <div class="box2"><div class="small">Fecha comprobación</div><input id="fechaComp" name="fecha_comprobacion" type="date"></div>
          <div class="row" style="margin-top:10px;">
          <div class="box2">
          <label style="text-align: center;" title="Marca si se realizo Reintegro o Depósito">
            <input type="checkbox" id="reintegro" name="reintegro_deposito">
            <strong>Reint/Dep</strong> 
          </label>
  </div>
</div>
        </div>
      </div>

      <div class="actions">
        <button type="submit">Guardar cambios</button>
        <button type="button" onclick="location.href='historial.html'">Volver</button>
        <button id="salir" onclick="logout()" style="margin-left:auto;">Salir</button>
      </div>
    </form>
  </div>
<script>
/* ----------------- EDIT.HTML: script corregido ------------------
 
   Asegúrate de dejar intacto el HTML (inputs con los mismos IDs).
*/

const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyOB-68HNJbUPuwd1wDkPJDnrxPDAMWCsaOVFN8n6JIQWnXbqlwszOtJ3YQZIVzG3Dwvg/exec"; // <- pon tu /exec aquí
const $ = id => document.getElementById(id);

// Normaliza/convierte fechas desde Google Sheets a yyyy-mm-dd para input[type=date]
// Acepta: "yyyy-mm-dd", "dd/mm/yyyy", "d/m/yyyy", "27 de octubre de 2025", Date object, número serial
function normalizeDate(raw){
  if (raw === null || raw === undefined) return "";

  // Si ya es Date object
  if (Object.prototype.toString.call(raw) === "[object Date]" || raw instanceof Date) {
    const d = new Date(raw.getTime());
    return d.toISOString().slice(0,10);
  }

  // Si es número (posible serial)
  if (typeof raw === "number") {
    // Asumimos serial tipo Excel/Sheets: days since 1899-12-30 (approx)
    const epoch = Date.UTC(1899,11,30); // 1899-12-30
    const ms = Math.round(raw * 24 * 60 * 60 * 1000);
    const d = new Date(epoch + ms);
    if (!isNaN(d.getTime())) return d.toISOString().slice(0,10);
  }

  // Si es string
  let s = String(raw).trim();
  if (!s) return "";

  // Caso ISO yyyy-mm-dd o yyyy-mm-ddTHH:MM:SSZ
  const isoMatch = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
  if (isoMatch) return `${isoMatch[1]}-${isoMatch[2]}-${isoMatch[3]}`;

  // Caso dd/mm/yyyy o d/m/yyyy
  const dmy = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if (dmy) {
    const day = dmy[1].padStart(2,"0");
    const mon = dmy[2].padStart(2,"0");
    const year = dmy[3];
    return `${year}-${mon}-${day}`;
  }

  // Caso largo "27 de octubre de 2025" (acepta mayúsculas/minúsculas)
  const long = s.toLowerCase().match(/^(\d{1,2})\s+de\s+([a-záéíóúñ]+)\s+de\s+(\d{4})$/i);
  if (long) {
    const meses = {
      enero:1,febrero:2,marzo:3,abril:4,mayo:5,junio:6,
      julio:7,agosto:8,septiembre:9,octubre:10,noviembre:11,diciembre:12
    };
    const day = String(long[1]).padStart(2,"0");
    const monthName = long[2].toLowerCase();
    const month = (meses[monthName] || 0);
    const year = long[3];
    if (month >= 1) {
      return `${year}-${String(month).padStart(2,"0")}-${day}`;
    }
  }

  // Caso con barra "-" tipo "27-10-2025"
  const dash = s.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/);
  if (dash) {
    const day = dash[1].padStart(2,'0');
    const mon = dash[2].padStart(2,'0');
    const yr = dash[3];
    return `${yr}-${mon}-${day}`;
  }

  // Si todo falla, retorna vacío para no poner valor inválido al input
  return "";
}

// Función que recibe el objeto devuelto por ?get=OFICIO (callback JSONP) o fetch
function onDataEdit(data){
  if(!data) { alert("No se encontró el oficio"); return; }

  // campos básicos
  $('oficio').value = data.oficio || "";

  $('fecha').value = normalizeDate(data.fecha);
  $('tipo').value = data.tipo || 'base';
  $('nombre').value = data.nombre || '';
  $('puesto').value = data.puesto || '';
  $('region').value = data.region || '';

  // fechas de comisión: fecha_inicio, fecha_fin (convertir antes de asignar)
  $('fechaInicio').value = normalizeDate(data.fecha_inicio);
  $('fechaFin').value = normalizeDate(data.fecha_fin);

  // texto concatenado y días (si existen en la fila original, los usamos; si no, calculamos)
  $('fechasComision').value = data.fechas_comision || '';
  $('diasComision').value = data.dias_comision || '';

  // resto de campos
  $('lugar').value = data.lugar || '';
  $('motivo').value = data.motivo || '';
  $('medio').value = data.medio_transporte || 'Vehículo Oficial';
  $('marca').value = data.marca || '';
  $('modelo').value = data.modelo || '';
  $('placa').value = data.placa || '';
  $('autoriza').value = data.autoriza || '';
  $('puestoAutoriza').value = data.puesto_autoriza || '';
  $('vobo').value = data.vobo || '';
  $('puestoVoBo').value = data.puesto_vobo || '';

  // anticipados
  $('antAlim').value = data.alim_antic || 0;
  $('antHosp').value = data.hosp_antic || 0;
  $('antComb').value = data.comb_antic || 0;
  $('antPeaje').value = data.peaje_antic || 0;
  $('antPas').value = data.pasajes_antic || 0;
  $('antOtros').value = data.otros_antic || 0;

  // devengados
  $('devAlim').value = data.alim_dev || 0;
  $('devHosp').value = data.hosp_dev || 0;
  $('devComb').value = data.comb_dev || 0;
  $('devPeaje').value = data.peaje_dev || 0;
  $('devPas').value = data.pasajes_dev || 0;
  $('devOtros').value = data.otros_dev || 0;

  // reintegro (puede venir TRUE/FALSE, true/false, "TRUE", "true")
  const reinVal = String(data.reintegro_deposito || "").toLowerCase();
  $('reintegro').checked = (reinVal === "true" || reinVal === "true" || reinVal === "1" || reinVal === "true");

  // fechas de anticipo y comprobación
  $('fechaAnt').value = normalizeDate(data.fecha_antic);
  $('fechaComp').value = normalizeDate(data.fecha_comprobacion);

  // recalcular totales y texto de fechas (si el usuario no desea que cambie, puede dejar vacío)
  updateTotalsAndDates();
  toggleVehiculo();
}

// Cargar el registro vía JSONP (para evitar CORS)
function loadRecordEdit(){
  const oficio = new URLSearchParams(location.search).get('oficio');
  if(!oficio) { alert("Falta oficio en la URL"); return; }
  // crear callback dinámico por si acaso
  const cb = "cb_edit_" + Date.now();
  window[cb] = function(d){
    try { onDataEdit(d); } finally { delete window[cb]; }
  };
  const s = document.createElement("script");
  s.src = `${SCRIPT_URL}?get=${encodeURIComponent(oficio)}&callback=${cb}`;
  document.body.appendChild(s);
}

/* --- helpers ya usados en tu edit (sin cambiar nombres de IDs) --- */
function toggleVehiculo(){
  const disable = $('medio').value !== "Vehículo Oficial";
  ['marca','modelo','placa'].forEach(id => {
    const el = $(id);
    if (el) {
      el.disabled = disable;
      if (disable) el.value = el.value || "";
    }
  });
}

function updateTotalsAndDates(){
  const idsAnt = ['antAlim','antHosp','antComb','antPeaje','antPas','antOtros'];
  const idsDev = ['devAlim','devHosp','devComb','devPeaje','devPas','devOtros'];
  const sum = (arr) => arr.reduce((s,id)=> s + Number( ( $(id) && $(id).value ) || 0 ), 0);

  const totalAnt = sum(idsAnt);
  const totalDev = sum(idsDev);
  const toMoney = x => Number(x||0).toLocaleString('es-MX',{minimumFractionDigits:2});

  const taEl = document.getElementById('totalAntDisplay');
  const tdEl = document.getElementById('totalDevDisplay');
  if (taEl) taEl.textContent = '$' + toMoney(totalAnt);
  if (tdEl) tdEl.textContent = '$' + toMoney(totalDev);

  // fechas largas y dias si tienen valores en los inputs tipo date
  const fi = $('fechaInicio').value, ff = $('fechaFin').value;
  if (fi && ff) {
    const [anio1, mes1, dia1] = fi.split('-').map(Number);
    const [anio2, mes2, dia2] = ff.split('-').map(Number);
    const d1 = new Date(anio1, mes1 - 1, dia1);
    const d2 = new Date(anio2, mes2 - 1, dia2);
    if (!isNaN(d1.getTime()) && !isNaN(d2.getTime())) {
      const months = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];
      $('fechasComision').value = `${d1.getDate()} de ${months[d1.getMonth()]} de ${d1.getFullYear()} al ${d2.getDate()} de ${months[d2.getMonth()]} de ${d2.getFullYear()}`;
      const diffDays = Math.round((d2 - d1)/(1000*60*60*24)) + 1;
      $('diasComision').value = diffDays >= 0 ? diffDays : '';
    }
  }
}

/* submit (update) — se conserva tu flujo: se envía como URLSearchParams para evitar preflight */
document.getElementById('form').addEventListener('submit', async function(e){
  e.preventDefault();
  const fm = new FormData(this);
  fm.set('_method','update');
  fm.set('reintegro_deposito', $('reintegro').checked ? 'TRUE' : 'FALSE');

  // totales
  const totalAnt = ['antAlim','antHosp','antComb','antPeaje','antPas','antOtros'].reduce((s,id)=> s + Number($(id).value||0),0);
  const totalDev = ['devAlim','devHosp','devComb','devPeaje','devPas','devOtros'].reduce((s,id)=> s + Number($(id).value||0),0);
  fm.set('total_antic', totalAnt);
  fm.set('total_dev', totalDev);

  const params = new URLSearchParams();
  for(const [k,v] of fm.entries()) params.append(k,v);

  try {
    const resp = await fetch(SCRIPT_URL, { method:'POST', body:params });
    const json = await resp.json();
    if (json.success) {
      alert('✅ Actualizado correctamente');
      location.href = 'historial.html';
    } else {
      alert('❌ Error: ' + (json.error || 'desconocido'));
    }
  } catch (err) {
    console.error(err);
    alert('Error al guardar (ver consola).');
  }
});

/* eventos */
['fechaInicio','fechaFin'].forEach(id => { if($(id)) $(id).addEventListener('change', updateTotalsAndDates); });
['antAlim','antHosp','antComb','antPeaje','antPas','antOtros','devAlim','devHosp','devComb','devPeaje','devPas','devOtros'].forEach(id=>{
  if($(id)) $(id).addEventListener('input', updateTotalsAndDates);
});
$('medio').addEventListener('change', toggleVehiculo);

/* inicio */
loadRecordEdit();
</script>
</body>
</html>
